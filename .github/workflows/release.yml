name: release

on:
  workflow_dispatch:
    inputs: 
      current_version:
        description: 'current version number'
        required: true
        type: string
      release_version:
        description: 'release version number'
        required: true
        type: string

jobs:
  release:
    env:
      CURRENT_VERSION: ${{ github.event.inputs.current_version }}
      RELEASE_VERSION: ${{ github.event.inputs.release_version }}
    runs-on: ubuntu-latest

    steps:
      - name: checkout code
        uses: actions/checkout@v2
      
      - name: git config
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "SpringQL release script"

      - name: edit changelog
        run: |
          # load helper script
          source .github/workflows/scripts/keep-a-changelog.bash
          # edit CHANGELOG.md
          cp CHANGELOG.md CHANGELOG.md.org
          cat CHANGELOG.md.org | bump_changelog "${CURRENT_VERSION}" "${RELEASE_VERSION}" > CHANGELOG.md
          rm CHANGELOG.md.org
      
      - name: bump crate versions
        run: |
          cd springql
          cargo bump "${RELEASE_VERSION}"
          cd ..
          cd springql-core
          cargo bump "${RELEASE_VERSION}"
          cd ..
          cd foreign-sevice
          cargo bump "${RELEASE_VERSION}"
          cd ..
          cd test-logger
          cargo bump "${RELEASE_VERSION}"
          cd ..

      - name: cargo publish
        run: |
          cargo login "${{ secrets.CRATES_IO_TOKEN }}"
          cargo publish -p springql-core
          cargo publish -p springql

      - name: commit changes
        run: |
          git add .
          git commit -m "update changelog for release ${RELEASE_VERSION}"

      - name: git tag
        run: |
          git tag "${RELEASE_VERSION}"
      
      - name: git push
        run: |
          git push origin "${RELEASE_VERSION}"
          git push origin main
